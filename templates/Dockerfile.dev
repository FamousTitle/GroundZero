ARG RUBY_VERSION=3.4.2
FROM ruby:${RUBY_VERSION}

ARG LOCAL_USER=rails
ARG NODE_VERSION=22
ARG RAILS_VERSION=8.0.2
ARG NPM_VERSION=latest
ARG YARN_VERSION=1.22.22
ARG UID=1000
ARG GID=1000

RUN apt-get update -qq && \
    apt-get install -y \
    build-essential \
    sudo \
    vim \
    libvips-dev \
    watchman \
    wget \
    gnupg2 \
    ca-certificates && \
    if [ "$(dpkg --print-architecture)" = "amd64" ]; then \
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /usr/share/keyrings/googlechrome-linux-keyring.gpg && \
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/googlechrome-linux-keyring.gpg] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list && \
        apt-get update -qq && \
        apt-get install -y google-chrome-stable; \
    else \
        apt-get install -y chromium chromium-driver; \
    fi && \
    rm -rf /var/lib/apt/lists/*

# Set Chrome paths based on architecture
RUN if [ "$(dpkg --print-architecture)" = "amd64" ]; then \
        echo 'export CHROME_BIN=/usr/bin/google-chrome-stable' >> /etc/environment && \
        echo 'export CHROME_PATH=/usr/bin/google-chrome-stable' >> /etc/environment; \
    else \
        echo 'export CHROME_BIN=/usr/bin/chromium' >> /etc/environment && \
        echo 'export CHROME_PATH=/usr/bin/chromium' >> /etc/environment && \
        echo 'export CHROMEDRIVER_PATH=/usr/bin/chromedriver' >> /etc/environment; \
    fi

ENV CHROME_BIN=${CHROME_BIN}
ENV CHROME_PATH=${CHROME_PATH}

# acknowledge sudo warning
RUN touch /var/lib/sudo/lectured/${LOCAL_USER}

# Create or Add group
RUN getent group $GID || groupadd $GID

# Create local user
RUN useradd -u $UID -g $GID -m $LOCAL_USER && echo "${LOCAL_USER}:${LOCAL_USER}" | chpasswd && adduser $LOCAL_USER sudo
RUN passwd -d $LOCAL_USER
RUN usermod -a -G users $LOCAL_USER

USER $LOCAL_USER

# Nodejs - needed for yarn
RUN curl -sL https://deb.nodesource.com/setup_${NODE_VERSION}.x | sudo bash - && sudo apt-get install -y nodejs

# Rails
RUN gem install rails -v=${RAILS_VERSION} --no-document

# NPM - yarn needed for rails new esbuild
RUN sudo npm install --force -g npm@${NPM_VERSION} yarn@$YARN_VERSION

# Setup aliases
RUN echo "alias rails='bundle exec rails'" >> ~/.bashrc
RUN echo "alias rspec='bundle exec rspec'" >> ~/.bashrc
RUN echo "alias rake='bundle exec rake'" >> ~/.bashrc
RUN echo "alias rubocop='bin/rubocop --cache true --autocorrect-all'" >> ~/.bashrc

WORKDIR /app

CMD ["bundle", "exec", "rails", "server"]
